<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新鮮菠蘿與啫喱虛擬實驗室 (iPad Compatible)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">

    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --primary: #f59e0b;       /* Amber 500 */
            --primary-hover: #d97706; 
            --secondary: #ec4899;     /* Pink 500 */
            --accent: #3b82f6;        /* Blue 500 */
            --success: #10b981;       /* Green 500 */
            --bg-app: #ffffff;        /* White Background */
            --bg-panel: #f8fafc;      /* Light Gray Panel */
            --text-main: #334155;     /* Slate 700 */
            --border: #000000;        /* Strict Black Borders for Line Art feel */
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --header-h: 64px;
            --zoom-bar-h: 50px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Prevent scrolling on body */
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            height: var(--header-h);
            background: var(--bg-panel);
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 20;
        }

        h1 { font-size: 1.25rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; }

        .nav-tabs { display: flex; gap: 8px; }
        .nav-btn {
            padding: 8px 16px; border: 2px solid transparent; background: transparent; border-radius: 6px;
            font-size: 0.9rem; cursor: pointer; color: #64748b; font-weight: 700; transition: all 0.2s;
        }
        .nav-btn.active { background: white; color: var(--text-main); border: 2px solid var(--border); border-bottom: none; position: relative; top: 2px; }
        .nav-btn.disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- LAYOUT --- */
        main {
            flex: 1;
            display: flex;
            position: relative;
            padding: 16px;
            height: calc(100vh - var(--header-h) - var(--zoom-bar-h));
            gap: 16px;
        }

        .view-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 16px;
            width: 100%;
            height: 100%;
        }
        
        .view-hidden { display: none !important; }

        /* --- TOOLBOX --- */
        .toolbox {
            background: var(--bg-panel); border-radius: 12px; border: 2px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
            z-index: 30;
        }
        .panel-header { padding: 12px 16px; background: #e2e8f0; font-weight: 700; border-bottom: 2px solid var(--border); }
        .tools-grid { padding: 16px; display: grid; grid-template-columns: 1fr; gap: 12px; overflow-y: auto; flex: 1; }
        
        .tool-card {
            display: flex; align-items: center; gap: 12px; padding: 10px;
            border: 2px solid #cbd5e1; border-radius: 8px; cursor: pointer; transition: transform 0.1s, border-color 0.2s;
            background: white;
        }
        .tool-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .tool-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        .control-panel { padding: 16px; border-top: 2px solid var(--border); background: #f8fafc; display: flex; gap: 8px; flex-direction: column; }
        .btn-start {
            width: 100%; padding: 12px; background: var(--text-main); color: white; border: none;
            border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: background 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-start:hover { background: #1e293b; }
        .btn-start.running { background: #ef4444; }
        .btn-start:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }

        .btn-reset {
            width: 100%; padding: 8px; background: white; color: var(--text-main); border: 2px solid var(--text-main);
            border-radius: 8px; font-weight: bold; font-size: 0.9rem; cursor: pointer;
        }
        .btn-reset:hover { background: #e2e8f0; }

        /* --- MAIN STAGE --- */
        .stage-container {
            background: white; border-radius: 12px; border: 2px solid var(--border);
            position: relative; overflow: hidden;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px;
            touch-action: none; /* Crucial for iPad drag */
        }

        /* Stage 2 Setup Zones */
        .setup-zone {
            position: absolute;
            top: 60px;
            width: 45%;
            bottom: 20px;
            border: 2px dashed #94a3b8;
            border-radius: 20px;
            background: rgba(241, 245, 249, 0.5);
            pointer-events: none; /* Visual only */
            display: flex; justify-content: center; padding-top: 10px;
        }
        .zone-label {
            background: #e2e8f0; padding: 4px 12px; border-radius: 12px; 
            font-weight: bold; color: var(--text-main); border: 2px solid var(--text-main);
            height: 32px;
        }

        /* --- TOOL TOGGLE --- */
        .tool-toggle {
            position: absolute; top: 16px; left: 16px;
            background: white; border: 2px solid var(--border); border-radius: 8px;
            display: flex; box-shadow: 4px 4px 0px rgba(0,0,0,0.1); z-index: 50;
        }
        .toggle-btn {
            padding: 8px 12px; border: none; background: transparent; cursor: pointer;
            color: var(--text-main); display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .toggle-btn:first-child { border-radius: 6px 0 0 6px; border-right: 2px solid var(--border); }
        .toggle-btn:last-child { border-radius: 0 6px 6px 0; }
        .toggle-btn.active { background: #e2e8f0; box-shadow: inset 2px 2px 4px rgba(0,0,0,0.1); }
        .toggle-btn:hover:not(.active) { background: #f9fafb; }

        /* --- CANVAS LAYERS --- */
        #items-layer, #items-layer-s2 {
            position: absolute; /* FIX: Ensure coordinate context is absolute */
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform-origin: top center; 
            transition: transform 0.05s linear;
        }

        .stage-container.cursor-mode { cursor: default; }
        .stage-container.pan-mode { cursor: grab; }
        .stage-container.pan-mode:active { cursor: grabbing; }

        /* --- ZOOM BAR --- */
        .zoom-bar {
            height: var(--zoom-bar-h); background: var(--bg-panel); border-top: 2px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            gap: 16px; padding: 0 24px; font-size: 0.9rem; font-weight: 700;
            color: var(--text-main); z-index: 30;
        }
        input[type=range] { accent-color: var(--text-main); cursor: pointer; }

        /* --- INSTRUCTION BUBBLE (S1) --- */
        .instruction-bubble {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 12px 24px; border-radius: 30px;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1); border: 2px solid var(--border);
            color: var(--text-main); font-weight: 700; font-size: 1rem;
            z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 8px;
            transition: all 0.3s ease; max-width: 90%; text-align: center;
        }
        .step-badge {
            background: var(--text-main); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; white-space: nowrap; margin-bottom: 4px;
        }
        .instruction-bubble.success { border-color: var(--success); }
        .instruction-bubble.success .step-badge { background: var(--success); }

        .btn-next-stage {
            margin-top: 8px; background: white; color: var(--text-main); border: 2px solid var(--text-main);
            padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.1); animation: pulse-btn 2s infinite;
        }
        .btn-next-stage:hover { background: #f1f5f9; transform: translate(-1px, -1px); }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- DRAGGABLE ITEMS --- */
        .draggable-item {
            position: absolute; cursor: grab; transform-origin: top left;
            touch-action: none; /* Prevent scroll */
        }
        .draggable-item.selected { outline: 2px dashed var(--accent); z-index: 1000; }
        .draggable-item:active { cursor: grabbing; }
        .draggable-item svg { display: block; width: 100%; height: 100%; pointer-events: none; overflow: visible !important; }

        .resize-handle {
            position: absolute; bottom: -6px; right: -6px; width: 14px; height: 14px;
            background: var(--accent); border: 2px solid white; border-radius: 50%;
            cursor: se-resize; display: none; z-index: 1001;
        }
        .draggable-item.selected .resize-handle { display: block; }

        .delete-btn {
            position: absolute; top: -10px; right: -10px; width: 24px; height: 24px;
            background: white; border: 2px solid var(--text-main); color: var(--text-main); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; cursor: pointer; opacity: 0;
            transform: scale(0.5); transition: all 0.2s; z-index: 1002;
        }
        .draggable-item:hover .delete-btn { opacity: 1; transform: scale(1); }

        /* Label Styles */
        .label-text { font-family: 'Noto Sans TC', sans-serif; font-weight: 700; font-size: 11px; fill: #000000; }
        .label-bg { fill: white; stroke: #000000; stroke-width: 1.5; rx: 4; }
        
        /* Digital Timer */
        .timer-text-digital { font-family: 'Roboto Mono', monospace; font-weight: 700; fill: #4ade80; font-size: 22px; }
        .timer-bg-rect { fill: #1f2937; }

    </style>
</head>
<body>

    <header>
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--text-main);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M9 12h6"></path><path d="M12 9v6"></path></svg>
            新鮮菠蘿與啫喱虛擬實驗室
        </h1>
        
        <nav class="nav-tabs">
            <button class="nav-btn active" id="btn-tab-1">Stage 1: 教學導覽</button>
            <button class="nav-btn disabled" id="btn-tab-2">Stage 2: 實驗設計</button>
        </nav>
    </header>

    <main>
        <!-- STAGE 1 VIEW -->
        <div id="view-stage1" class="view-container">
            <aside class="toolbox">
                <div class="panel-header">器材清單</div>
                <div class="tools-grid" id="tools-container"></div>
                <div class="control-panel">
                    <button class="btn-start" id="btn-experiment" onclick="app.toggleExperiment()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg>
                        開始實驗
                    </button>
                </div>
            </aside>

            <section class="stage-container cursor-mode" id="main-stage">
                <div class="tool-toggle">
                    <button class="toggle-btn active" id="btn-tool-cursor" onclick="app.setTool('cursor')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path><path d="M13 13l6 6"></path></svg>
                    </button>
                    <button class="toggle-btn" id="btn-tool-pan" onclick="app.setTool('pan')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"></path><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"></path><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"></path><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"></path></svg>
                    </button>
                </div>

                <div class="instruction-bubble" id="instruction-bubble">
                    <span class="step-badge" id="step-badge">Step 0</span>
                    <div id="instruction-text">載入中...</div>
                </div>
                
                <div id="items-layer"></div>
            </section>
        </div>

        <!-- STAGE 2 VIEW -->
        <div id="view-stage2" class="view-container view-hidden">
            <aside class="toolbox">
                <div class="panel-header">實驗設計 (進階)</div>
                <div class="tools-grid" id="tools-container-s2"></div>
                <div class="control-panel">
                    <button class="btn-start" id="btn-experiment-s2" onclick="app.toggleExperiment()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg>
                        開始實驗
                    </button>
                    <button class="btn-reset" onclick="app.resetStage2()">重置 (Reset)</button>
                </div>
            </aside>

            <section class="stage-container cursor-mode" id="main-stage-s2">
                <div style="position: absolute; top:0; width:100%; text-align:center; padding:8px; font-weight:bold; background:rgba(255,255,255,0.9); border-bottom:1px solid #cbd5e1;">運用提供的材料設計一個實驗以探究令啫喱變得水狀的因素</div>
                
                <!-- Setup Zones -->
                <div class="setup-zone" style="left: 2.5%;">
                    <div class="zone-label">實驗裝置 1</div>
                </div>
                <div class="setup-zone" style="right: 2.5%;">
                    <div class="zone-label">實驗裝置 2</div>
                </div>

                <div class="tool-toggle">
                    <button class="toggle-btn active" id="btn-tool-cursor-s2" onclick="app.setTool('cursor')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path><path d="M13 13l6 6"></path></svg>
                    </button>
                    <button class="toggle-btn" id="btn-tool-pan-s2" onclick="app.setTool('pan')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"></path><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"></path><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"></path><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"></path></svg>
                    </button>
                </div>

                <div id="items-layer-s2"></div>
            </section>
        </div>
    </main>
    
    <footer class="zoom-bar">
        <label for="zoom-slider">放大/縮細 (Zoom):</label>
        <div style="display:flex; align-items:center; gap:8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
            <input type="range" id="zoom-slider" min="50" max="200" step="1" value="100" oninput="app.setZoom(this.value)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
        </div>
        <span id="zoom-val">100%</span>
    </footer>

    <script>
        // --- 1. SVG GENERATORS (SOLID COLORS WITH EXACT GEOMETRY) ---
        
        const generateRulerTicks = () => {
            let svg = '';
            for (let y = 0; y <= 300; y += 10) {
                const isMajor = y % 50 === 0;
                const len = isMajor ? 15 : 8; 
                svg += `<line x1="${40-len}" y1="${y}" x2="40" y2="${y}" />`;
                if (isMajor) {
                    let textY = y + 5;
                    if (y === 0) textY = y + 12; if (y === 300) textY = y - 5;
                    svg += `<text x="12" y="${textY}" font-size="12" fill="#334155" text-anchor="middle" font-family="sans-serif">${y/10}</text>`;
                }
            }
            return svg;
        };

        const createJellySVG = (colorBody, colorStroke, colorLiquid, w, h) => {
            const uid = 'jelly-' + Math.random().toString(36).substr(2, 9);
            const cx = w/2; 
            
            // Geometric Calculations for Perfect Connection
            const topY = 20;
            const botY = h - 10;
            const rxBase = w/2 - 5;
            const rxTop = rxBase * 0.7; // Taper ratio
            
            // Tangent points for the body path
            const tlX = cx - rxTop;
            const trX = cx + rxTop;
            const blX = cx - rxBase;
            const brX = cx + rxBase;

            return `
            <svg viewBox="0 0 ${w} ${h}">
                <defs>
                    <linearGradient id="grad-${uid}" x1="0" y1="0" x2="0" y2="1">
                        <stop id="stop1-${uid}" offset="0%" stop-color="${colorLiquid}" stop-opacity="0.8" />
                        <stop id="stop2-${uid}" offset="0%" stop-color="${colorLiquid}" stop-opacity="0.5" />
                        <stop id="stop3-${uid}" offset="0%" stop-color="${colorBody}" stop-opacity="0" />
                        <stop offset="100%" stop-color="${colorBody}" stop-opacity="0" />
                    </linearGradient>
                    <marker id="arrow-${uid}" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                        <path d="M0,0 L6,3 L0,6 L0,0" fill="#000000" />
                    </marker>
                </defs>
                
                <!-- LAYER 1: SOLID BASE (Permanently Visible) -->
                <g id="base-${uid}">
                    <!-- Base Ellipse -->
                    <ellipse cx="${cx}" cy="${botY}" rx="${rxBase}" ry="8" fill="#e2e8f0" stroke="${colorStroke}" stroke-width="2"/>
                    <!-- Solid Body Path (Trapezoid connecting tangents) -->
                    <path d="M${tlX} ${topY} L${blX} ${botY} A${rxBase} 8 0 0 0 ${brX} ${botY} L${trX} ${topY} Z" 
                          fill="${colorBody}" stroke="${colorStroke}" stroke-width="2"/>
                    <!-- Top Ellipse -->
                    <ellipse cx="${cx}" cy="${topY}" rx="${rxTop}" ry="6" fill="${colorBody}" stroke="${colorStroke}" stroke-width="2"/>
                </g>

                <!-- LAYER 2: LIQUID OVERLAY (Animates Opacity) -->
                <g id="liquid-${uid}" opacity="0">
                    <path d="M${tlX} ${topY} L${blX} ${botY} A${rxBase} 8 0 0 0 ${brX} ${botY} L${trX} ${topY} Z" 
                          fill="url(#grad-${uid})" stroke="none"/>
                    <ellipse id="surf-${uid}" cx="${cx}" cy="${topY}" rx="${rxTop}" ry="6" fill="${colorLiquid}" stroke="none"/>
                </g>

                <!-- LABEL (Standardized Size) -->
                <g id="label-${uid}" opacity="0" style="transition: opacity 0.5s ease;">
                    <line x1="${w+5}" y1="32" x2="${w*0.6}" y2="32" stroke="#000000" stroke-width="1.5" marker-end="url(#arrow-${uid})" />
                    <rect x="${w+5}" y="22" width="50" height="20" class="label-bg" />
                    <text x="${w+30}" y="33" text-anchor="middle" dominant-baseline="middle" class="label-text">液化層</text>
                </g>
            </svg>`;
        };

        const ASSETS = {
            pineapple: { name: "菠蘿圓片", w: 100, h: 100, svg: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#fcd34d" stroke="#b45309" stroke-width="3"/><circle cx="50" cy="50" r="15" fill="#fef3c7" stroke="#b45309" stroke-width="2" stroke-dasharray="4 2"/><path d="M50 5 L50 20 M50 80 L50 95 M5 50 L20 50 M80 50 L95 50" stroke="#b45309" stroke-width="2"/><path d="M25 25 L35 35 M75 25 L65 35 M25 75 L35 65 M75 75 L65 65" stroke="#b45309" stroke-width="2"/></svg>` },
            pineapple_chunk: { name: "菠蘿切塊", w: 60, h: 60, svg: `<svg viewBox="0 0 60 60"><path d="M0 60 L60 60 A 60 60 0 0 0 0 0 Z" fill="#fcd34d" stroke="#b45309" stroke-width="2"/><path d="M15 45 A 20 20 0 0 0 25 35" fill="none" stroke="#b45309" stroke-width="1" stroke-dasharray="2 2"/></svg>` },
            ruler: { name: "直尺", w: 40, h: 300, svg: `<svg viewBox="0 0 40 300"><rect x="0" y="0" width="40" height="300" rx="2" fill="#f8fafc" stroke="#334155" stroke-width="2"/><g stroke="#334155" stroke-width="1.5" font-family="sans-serif">${generateRulerTicks()}</g></svg>` },
            stopwatch: { name: "計時器", w: 120, h: 80, svg: `<svg viewBox="0 0 120 80"><rect x="25" y="0" width="20" height="15" rx="2" fill="#ef4444" stroke="#b91c1c" stroke-width="1"/><rect x="75" y="0" width="20" height="15" rx="2" fill="#3b82f6" stroke="#1d4ed8" stroke-width="1"/><rect x="5" y="15" width="110" height="60" rx="8" fill="#e5e7eb" stroke="#374151" stroke-width="3"/><rect class="timer-bg-rect" x="15" y="25" width="90" height="40" rx="4" stroke="#1f2937" stroke-width="1"/><text class="timer-display timer-text-digital" x="60" y="53" text-anchor="middle">00:00</text></svg>` },
            thermometer: { name: "溫度計", w: 80, h: 120, svg: `<svg viewBox="0 0 80 120"><rect x="15" y="0" width="10" height="100" rx="5" fill="white" stroke="#334155" stroke-width="2"/><circle cx="20" cy="100" r="12" fill="#ef4444" stroke="#334155" stroke-width="2"/><rect x="18" y="40" width="4" height="60" fill="#ef4444"/><line x1="25" y1="20" x2="30" y2="20" stroke="#334155" stroke-width="1"/><line x1="25" y1="40" x2="30" y2="40" stroke="#334155" stroke-width="1"/><text class="temp-text" x="35" y="105" font-size="16" fill="#334155" font-weight="bold">25°C</text></svg>` },
            
            // Icons for sidebar (Updated Darker Colors for Lime)
            jelly: { name: "果凍", icon: `<svg viewBox="0 0 120 90"><ellipse cx="60" cy="80" rx="55" ry="8" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/><path d="M25 20 L95 20 L105 75 L15 75 Z" fill="#9B59B6" stroke="#6C3483" stroke-width="2"/><ellipse cx="60" cy="20" rx="35" ry="6" fill="#AF7AC5" stroke="#6C3483" stroke-width="2"/></svg>` },
            
            // Darker Lime Green
            jelly_lime: { name: "青檸味啫喱 (標準)", icon: `<svg viewBox="0 0 120 90"><ellipse cx="60" cy="80" rx="55" ry="8" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/><path d="M25 20 L95 20 L105 75 L15 75 Z" fill="#84cc16" stroke="#365314" stroke-width="2"/><ellipse cx="60" cy="20" rx="35" ry="6" fill="#bef264" stroke="#365314" stroke-width="2"/></svg>` },
            
            jelly_straw: { name: "士多啤梨味啫喱", icon: `<svg viewBox="0 0 120 90"><ellipse cx="60" cy="80" rx="55" ry="8" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/><path d="M25 20 L95 20 L105 75 L15 75 Z" fill="#fb7185" stroke="#be123c" stroke-width="2"/><ellipse cx="60" cy="20" rx="35" ry="6" fill="#fda4af" stroke="#be123c" stroke-width="2"/></svg>` },
            
            jelly_small: { name: "青檸味啫喱 (少量)", icon: `<svg viewBox="0 0 120 90"><ellipse cx="60" cy="80" rx="55" ry="8" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/><path d="M35 30 L85 30 L90 60 L30 60 Z" fill="#84cc16" stroke="#365314" stroke-width="2"/><ellipse cx="60" cy="30" rx="25" ry="4" fill="#bef264" stroke="#365314" stroke-width="2"/></svg>` }
        };

        const TUTORIAL_STEPS = [
            { id: 0, text: "歡迎！實驗面板左上角可切換『游標模式 (選取)』或『手形模式 (平移)』。請先熟悉視角操作，然後點擊側邊欄的 '果凍' 開始。", check: 'hasJelly' },
            { id: 1, text: "請加入 '菠蘿圓片' 並將其放置在果凍上方。", check: 'hasPineappleOverlap' },
            { id: 2, text: "請加入 '溫度計' 以監測室溫。", check: 'hasThermometer' },
            { id: 3, text: "請加入 '電子計時器' 準備計時。", check: 'hasStopwatch' },
            { id: 4, text: "點擊 '開始實驗' 按鈕 (將啟動縮時攝影模式)。", check: 'isRunning' },
            { id: 5, text: "觀察縮時變化 (首10分鐘為觀察期)。", check: 'isFinished' },
            { id: 6, text: "實驗結束！請思考：我們可以用什麼方法來觀察或測量啫喱的『凝固狀態』？", check: 'done' }
        ];

        // --- 3. APP LOGIC ---
        const app = {
            stage: 1, zIndex: 100, tutorialStep: 0, zoomLevel: 1.0, panX: 0, panY: 0, toolMode: 'cursor',
            experiment: { running: false, elapsed: 0, intervalId: null },
            interaction: { type: null, target: null, startX: 0, startY: 0 },
            dragGroup: [],
            
            init() {
                this.renderToolbox();
                this.attachListeners();
                this.updateTutorialUI();
            },

            // --- HELPER: NORMALIZE TOUCH/MOUSE ---
            getPos(e) {
                return e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
            },

            // --- STAGE SWITCHING ---
            goToStage2() {
                this.stage = 2;
                document.getElementById('view-stage1').classList.add('view-hidden');
                document.getElementById('view-stage2').classList.remove('view-hidden');
                document.getElementById('btn-tab-1').classList.remove('active');
                document.getElementById('btn-tab-2').classList.add('active');
                document.getElementById('btn-tab-2').classList.remove('disabled');
                this.resetStage2();
                this.renderToolbox();
            },

            resetStage2() {
                this.stopExperiment();
                this.experiment.elapsed = 0;
                this.updateDisplay();
                
                // Clear items logic: remove all children
                const layer = document.getElementById('items-layer-s2');
                while(layer.firstChild) layer.removeChild(layer.firstChild);

                const btn = document.getElementById('btn-experiment-s2');
                btn.disabled = false;
                btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg> 開始實驗`;
                
                // FIX: Force Cursor Mode so user can drag items
                this.setTool('cursor');
                this.interaction = { type: null };
            },

            // --- UI RENDER ---
            renderToolbox() {
                const cId = this.stage === 1 ? 'tools-container' : 'tools-container-s2';
                const container = document.getElementById(cId);
                container.innerHTML = '';
                
                const add = (id, name, iconHtml, typeTag) => {
                    const btn = document.createElement('div');
                    btn.className = 'tool-card';
                    btn.innerHTML = `<div class="tool-icon">${iconHtml}</div><span>${name}</span>`;
                    const svg = btn.querySelector('svg');
                    if(svg) { svg.removeAttribute('viewBox'); svg.setAttribute('viewBox','0 0 100 100'); svg.style.width='32px'; svg.style.height='32px'; }
                    btn.onclick = () => this.addItem(typeTag || id);
                    container.appendChild(btn);
                };

                if (this.stage === 1) {
                    add('jelly', ASSETS.jelly.name, ASSETS.jelly.icon, 'jelly-std');
                    add('pineapple', ASSETS.pineapple.name, ASSETS.pineapple.svg);
                    add('ruler', ASSETS.ruler.name, ASSETS.ruler.svg);
                    add('thermometer', ASSETS.thermometer.name, ASSETS.thermometer.svg);
                    add('stopwatch', ASSETS.stopwatch.name, ASSETS.stopwatch.svg);
                } else {
                    add('jelly-lime', '青檸味啫喱 (標準)', ASSETS.jelly_lime.icon, 'jelly-lime');
                    add('jelly-straw', '士多啤梨味啫喱', ASSETS.jelly_straw.icon, 'jelly-straw');
                    add('jelly-sm', '青檸味啫喱 (少量)', ASSETS.jelly_small.icon, 'jelly-sm');
                    add('pineapple', '菠蘿圓片', ASSETS.pineapple.svg, 'pineapple');
                    add('stopwatch', ASSETS.stopwatch.name, ASSETS.stopwatch.svg);
                    add('thermometer', ASSETS.thermometer.name, ASSETS.thermometer.svg);
                    add('ruler', ASSETS.ruler.name, ASSETS.ruler.svg);
                }
            },

            updateTutorialUI() {
                if(this.stage !== 1) return;
                const bubble = document.getElementById('instruction-bubble');
                const text = document.getElementById('instruction-text');
                const badge = document.getElementById('step-badge');
                
                badge.textContent = `Step ${this.tutorialStep}`;
                if (this.tutorialStep === 6) {
                    bubble.classList.add('success');
                    badge.textContent = "討論";
                    text.innerHTML = `<p style="margin-bottom:8px">實驗結束！請思考：我們可以用什麼方法來觀察或測量啫喱的『凝固狀態』？</p><button class="btn-next-stage" onclick="app.goToStage2()">前往第二階段：實驗設計</button>`;
                } else {
                    text.textContent = TUTORIAL_STEPS[this.tutorialStep].text;
                }
            },

            // --- ITEM LOGIC ---
            addItem(type) {
                const layerId = this.stage === 1 ? 'items-layer' : 'items-layer-s2';
                const layer = document.getElementById(layerId);
                const stageEl = this.stage === 1 ? document.getElementById('main-stage') : document.getElementById('main-stage-s2');
                
                const el = document.createElement('div');
                el.className = 'draggable-item';
                
                let svgHtml = '';
                let w=100, h=100;

                // Scale factor for Stage 2 visibility
                const scale = (this.stage === 2) ? 1.3 : 1.0;

                if (type.includes('jelly')) {
                    el.classList.add('item-jelly');
                    el.dataset.jellyType = type;
                    // Colors
                    let cB='#9B59B6', cS='#6C3483', cL='#bae6fd'; // Default Purple
                    
                    if(type === 'jelly-lime' || type === 'jelly-sm') { 
                        cB='#84cc16'; cS='#365314'; cL='#ecfccb'; // Darker Lime
                    }
                    if(type === 'jelly-straw') { 
                        cB='#fb7185'; cS='#be123c'; cL='#ffe4e6'; // Strawberry
                    } 
                    
                    // Size
                    if(type === 'jelly-sm') { w=90; h=60; } else { w=120; h=90; }
                    
                    // Apply Scale
                    w *= scale;
                    h *= scale;

                    svgHtml = createJellySVG(cB, cS, cL, w, h);
                } else {
                    const asset = ASSETS[type]; 
                    if(asset) { 
                        w = asset.w; 
                        h = asset.h; 
                        
                        // Apply Scale
                        w *= scale;
                        h *= scale;

                        svgHtml = asset.svg; 
                        el.classList.add(`item-${type}`); 
                    }
                }

                el.style.width = w+'px'; el.style.height = h+'px';
                
                // Resize Handle Logic: Only in Stage 1, and NOT for Ruler.
                const canResize = (this.stage === 1) && (type !== 'ruler');
                const resize = canResize ? '<div class="resize-handle"></div>' : '';
                
                el.innerHTML = `${svgHtml}<div class="delete-btn">×</div>${resize}`;

                const handleStart = (e) => this.handleDown(e, el);
                el.addEventListener('mousedown', handleStart);
                el.addEventListener('touchstart', handleStart, {passive: false});

                const delBtn = el.querySelector('.delete-btn');
                const deleteAction = (e) => { 
                    e.stopPropagation(); 
                    el.remove(); 
                    if(this.stage===1) this.checkStep(); 
                };
                delBtn.addEventListener('click', deleteAction);
                delBtn.addEventListener('touchstart', deleteAction); // iPad tap
                delBtn.addEventListener('mousedown', e=>e.stopPropagation());

                layer.appendChild(el);
                
                // Spawn Logic
                const rect = stageEl.getBoundingClientRect();
                let iX, iY;

                if (this.stage === 1) {
                    const bubble = document.getElementById('instruction-bubble');
                    const bRect = bubble.getBoundingClientRect();
                    const bCenterX = bRect.left + bRect.width / 2;
                    const relX = bCenterX - rect.left;
                    iX = (relX - this.panX) / this.zoomLevel;
                    iY = (rect.height * 0.4 - this.panY) / this.zoomLevel;
                } else {
                    iX = (rect.width/2 - this.panX)/this.zoomLevel;
                    iY = (rect.height/2 - this.panY)/this.zoomLevel;
                }

                el.style.left = (iX - w/2)+'px'; 
                el.style.top = (iY - h/2)+'px';
                el.style.zIndex = this.zIndex++;

                if(this.toolMode === 'cursor') this.select(el);
                if(this.stage===1) this.checkStep();
            },

            select(item) {
                if(this.selected) this.selected.classList.remove('selected');
                this.selected = item;
                if(item) { item.classList.add('selected'); item.style.zIndex = this.zIndex++; }
            },

            // --- INTERACTION ---
            setTool(m) {
                this.toolMode = m;
                const s1 = document.getElementById('main-stage');
                const s2 = document.getElementById('main-stage-s2');
                [s1,s2].forEach(s => { s.classList.toggle('cursor-mode', m==='cursor'); s.classList.toggle('pan-mode', m==='pan'); });
                
                const btns = this.stage===1 ? ['btn-tool-cursor','btn-tool-pan'] : ['btn-tool-cursor-s2','btn-tool-pan-s2'];
                document.getElementById(btns[0]).classList.toggle('active', m==='cursor');
                document.getElementById(btns[1]).classList.toggle('active', m==='pan');
                
                if(m==='pan') this.select(null);
            },

            setZoom(v) {
                this.zoomLevel = parseFloat(v)/100;
                document.getElementById('zoom-val').textContent = v+'%';
                this.updateTransform();
            },

            updateTransform() {
                const tr = `translate(${this.panX}px, ${this.panY}px) scale(${this.zoomLevel})`;
                document.getElementById('items-layer').style.transform = tr;
                document.getElementById('items-layer-s2').style.transform = tr;
            },

            handleDown(e, item) {
                // Determine event type
                if (e.type === 'mousedown' && e.button !== 0) return;
                
                // Stop scroll on touch
                if(e.type === 'touchstart') e.preventDefault();

                if(this.toolMode==='pan') { this.startPan(e); return; }
                if(e.target.classList.contains('resize-handle')) this.startResize(e, item);
                else { this.select(item); this.startDrag(e, item); }
            },

            startDrag(e, item) {
                e.stopPropagation();
                this.dragGroup = [];
                const pos = this.getPos(e);
                
                if (item.classList.contains('item-jelly')) {
                    const layer = item.parentElement;
                    const others = layer.querySelectorAll('.item-pineapple, .item-pineapple_chunk, .item-thermometer');
                    others.forEach(other => {
                        if (this.checkOverlap(item, other)) {
                            this.dragGroup.push({
                                el: other,
                                offX: parseFloat(other.style.left) - parseFloat(item.style.left),
                                offY: parseFloat(other.style.top) - parseFloat(item.style.top)
                            });
                        }
                    });
                }

                this.interaction = { 
                    type: 'drag', 
                    target: item, 
                    startX: (pos.x - item.getBoundingClientRect().left)/this.zoomLevel, 
                    startY: (pos.y - item.getBoundingClientRect().top)/this.zoomLevel 
                };
            },

            startResize(e, item) {
                e.stopPropagation();
                const pos = this.getPos(e);
                const rect = item.parentElement.getBoundingClientRect();
                this.interaction = { type: 'resize', target: item, startX: (pos.x - rect.left)/this.zoomLevel, initW: parseFloat(item.style.width), initH: parseFloat(item.style.height) };
                this.interaction.aspect = this.interaction.initW / this.interaction.initH;
            },

            startPan(e) {
                const pos = this.getPos(e);
                this.interaction = { type: 'pan', startX: pos.x, startY: pos.y, initX: this.panX, initY: this.panY };
            },

            attachListeners() {
                const startHandler = (e) => {
                    // Only background or empty layer area
                    const el = e.currentTarget;
                    if(e.target === el || e.target.id.includes('items-layer')) {
                        if(e.type === 'touchstart') e.preventDefault();
                        if(this.toolMode==='cursor') this.select(null); else this.startPan(e);
                    }
                };

                ['main-stage', 'main-stage-s2'].forEach(id => {
                    const el = document.getElementById(id);
                    el.addEventListener('mousedown', startHandler);
                    el.addEventListener('touchstart', startHandler, {passive: false});
                });

                const moveHandler = (e) => {
                    if(!this.interaction.type) return;
                    e.preventDefault(); // Stop scroll
                    const i = this.interaction;
                    const pos = this.getPos(e);
                    
                    if(i.type === 'pan') {
                        this.panX = i.initX + (pos.x - i.startX);
                        this.panY = i.initY + (pos.y - i.startY);
                        this.updateTransform();
                    } else {
                        const layer = i.target.parentElement;
                        const rect = layer.getBoundingClientRect();
                        
                        if(i.type === 'drag') {
                            const x = (pos.x - rect.left)/this.zoomLevel - i.startX;
                            const y = (pos.y - rect.top)/this.zoomLevel - i.startY;
                            i.target.style.left = x+'px'; 
                            i.target.style.top = y+'px';
                            
                            if (this.dragGroup.length > 0) {
                                this.dragGroup.forEach(child => {
                                    child.el.style.left = (x + child.offX) + 'px';
                                    child.el.style.top = (y + child.offY) + 'px';
                                });
                            }

                            if(this.experiment.running) this.updateSimulation();
                        } else if (i.type === 'resize') {
                            const dx = ((pos.x - rect.left)/this.zoomLevel) - i.startX;
                            const nw = Math.max(40, i.initW + dx);
                            i.target.style.width = nw+'px';
                            i.target.style.height = (nw/i.aspect)+'px';
                        }
                    }
                };

                window.addEventListener('mousemove', moveHandler);
                window.addEventListener('touchmove', moveHandler, {passive: false});

                const endHandler = () => {
                    if(this.interaction.type === 'drag' && this.stage === 1) this.checkStep();
                    this.interaction.type = null;
                    this.dragGroup = [];
                };

                window.addEventListener('mouseup', endHandler);
                window.addEventListener('touchend', endHandler);
            },

            // --- SIMULATION ---
            toggleExperiment() {
                if(this.stage===2 && !document.querySelector('#items-layer-s2 .item-stopwatch')) {
                    alert("請先將『電子計時器』加入實驗區！");
                    return;
                }

                if(this.experiment.running) this.stopExperiment();
                else {
                    this.experiment.running = true;
                    const btnId = this.stage===1 ? 'btn-experiment' : 'btn-experiment-s2';
                    const btn = document.getElementById(btnId);
                    btn.classList.add('running');
                    btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16" fill="currentColor"></rect><rect x="14" y="4" width="4" height="16" fill="currentColor"></rect></svg> 停止實驗`;
                    
                    if(this.stage===1) this.checkStep();

                    this.experiment.intervalId = setInterval(() => {
                        this.experiment.elapsed += 300000;
                        this.updateDisplay();
                        this.updateSimulation();
                        if(this.experiment.elapsed >= 1800000) this.finishExperiment();
                    }, 1000);
                }
            },

            stopExperiment() {
                this.experiment.running = false;
                clearInterval(this.experiment.intervalId);
                const btnId = this.stage===1 ? 'btn-experiment' : 'btn-experiment-s2';
                const btn = document.getElementById(btnId);
                btn.classList.remove('running');
                btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg> 開始實驗`;
            },

            finishExperiment() {
                this.stopExperiment();
                const btnId = this.stage===1 ? 'btn-experiment' : 'btn-experiment-s2';
                document.getElementById(btnId).disabled = true;
                document.getElementById(btnId).innerHTML = `實驗結束`;
                
                // Final Check: Show labels for anything that reacted
                this.updateSimulation(true); 
                
                if(this.stage===1) {
                    this.tutorialStep = 6;
                    this.updateTutorialUI();
                }
            },

            updateDisplay() {
                const m = Math.floor(this.experiment.elapsed/60000).toString().padStart(2,'0');
                const s = "00";
                document.querySelectorAll('.timer-display').forEach(e => e.textContent = `${m}:${s}`);
            },

            checkOverlap(el1, el2) {
                const r1 = el1.getBoundingClientRect(); const r2 = el2.getBoundingClientRect();
                return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
            },

            updateSimulation(forceShowLabel = false) {
                const selector = this.stage === 1 ? '#items-layer' : '#items-layer-s2';
                const jellies = document.querySelectorAll(`${selector} .item-jelly`);
                const pines = document.querySelectorAll(`${selector} .item-pineapple, ${selector} .item-pineapple_chunk`); 

                jellies.forEach(j => {
                    let start = -1;
                    let hasContact = false;
                    let pineappleStrength = 0; // 0=None, 1=Chunk, 2=Ring

                    // 1. Determine Pineapple Strength on this Jelly
                    pines.forEach(p => { 
                        if(this.checkOverlap(p, j)) {
                            hasContact = true;
                            if(p.classList.contains('item-pineapple')) {
                                pineappleStrength = 2; // Ring overrides chunk if both present (or multiple)
                            } else if (p.classList.contains('item-pineapple_chunk') && pineappleStrength < 2) {
                                pineappleStrength = 1; // Chunk
                            }
                        }
                    });

                    // 2. Determine Jelly Mass
                    // "jelly-sm" is 10g (Lower Mass), others are 20g (Standard)
                    const isSmallMass = j.dataset.jellyType && j.dataset.jellyType.includes('jelly-sm');

                    // 3. Determine Start Time based on Rules
                    if (hasContact) {
                        if (pineappleStrength === 2) {
                            // Ring: High Enzyme
                            start = isSmallMass ? 180000 : 300000; // 3:00 (Small) vs 5:00 (Std)
                        } else if (pineappleStrength === 1) {
                            // Chunk: Low Enzyme
                            start = isSmallMass ? 600000 : 900000; // 10:00 (Small) vs 15:00 (Std)
                        }
                        
                        // Stage 1 Tutorial Override: Always start at 10:00 to match tutorial flow
                        if (this.stage === 1 && pineappleStrength > 0) start = 600000; 
                    }

                    // Calculate Progress to span until 30:00 (1800000)
                    let progress = 0;
                    if (start !== -1 && this.experiment.elapsed >= start) {
                        const endTime = 1800000; // 30 mins
                        const duration = endTime - start;
                        if (duration > 0) {
                            progress = Math.min((this.experiment.elapsed - start) / duration, 1);
                        } else {
                            progress = 1;
                        }
                    }

                    // Apply Visuals
                    const liquidLayer = j.querySelector('[id^="liquid-"]');
                    const stops = j.querySelectorAll('stop');
                    const label = j.querySelector('[id^="label-"]');

                    if (liquidLayer && stops.length >= 3) {
                        if (progress > 0) {
                            liquidLayer.setAttribute('opacity', '1');
                            
                            // Variable Melt Extent Logic
                            let maxExtent = 33; // Default 33%
                            if (pineappleStrength === 2 && isSmallMass) maxExtent = 60; // Max melt for Ring + Small
                            else if (pineappleStrength === 2 && !isSmallMass) maxExtent = 40; // Ring + Standard
                            else if (pineappleStrength === 1 && isSmallMass) maxExtent = 25; // Chunk + Small
                            else if (pineappleStrength === 1 && !isSmallMass) maxExtent = 15; // Chunk + Standard
                            
                            // Stage 1 Override
                            if (this.stage === 1) maxExtent = 33;

                            const meltPct = progress * maxExtent; 
                            stops[1].setAttribute('offset', meltPct+'%');
                            stops[2].setAttribute('offset', meltPct+'%');
                            
                            // Show label if finished or forced
                            if (forceShowLabel || progress >= 1) {
                                if(label) label.setAttribute('opacity', '1');
                            }
                        } else {
                            liquidLayer.setAttribute('opacity', '0');
                        }
                    }
                });
            },

            checkStep() {
                if(this.stage!==1) return;
                const req = TUTORIAL_STEPS[this.tutorialStep].check;
                let next = false;
                const l = document.getElementById('items-layer');
                const j = l.querySelector('.item-jelly');
                const p = l.querySelector('.item-pineapple');
                const t = l.querySelector('.item-thermometer');
                const s = l.querySelector('.item-stopwatch');

                if(req==='hasJelly' && j) next=true;
                else if(req==='hasPineappleOverlap' && p && j && this.checkOverlap(p,j)) next=true;
                else if(req==='hasThermometer' && t) next=true;
                else if(req==='hasStopwatch' && s) next=true;
                else if(req==='isRunning' && this.experiment.running) next=true;

                if(next) { this.tutorialStep++; this.updateTutorialUI(); if(this.tutorialStep<6) this.checkStep(); }
            }
        };

        app.init();

    </script>
</body>
</html>